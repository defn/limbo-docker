#!/usr/bin/env bash

function lxc {
  limbo lxc "$@"
}

function main {
  local shome="${_limbo_home:-"$(cd -P -- "$(dirname -- "$BASH_SOURCE")/.." && pwd -P)"}"
  source "$shome/script/profile"

  local nm_lxd='docker'
  local net_docker="$BASEBOX_DOCKER_NETWORK_PREFIX"
  local nm_docker="$BASEBOX_INSTANCE"

  if [[ "$#" != 0 ]]; then
    nm_lxd="$1"; shift
    nm_docker="$nm_lxd"
    net_docker="$1"; shift
  fi

  set -x

  if [[ "$nm_lxd" == "docker" ]]; then
    lxc config set storage.lvm_volume_size 20GiB
    lxc launch ubuntu:16.04 "$nm_lxd" -p default -p docker -p limbo -c boot.autostart=true -c security.nesting=true -c security.privileged=true || true
    sleep 10

    echo "Acquire::http::Proxy \"http://$CACHE_VIP:3128\";" > ".99boxcache.$$" 
    lxc file push ".99boxcache.$$" "${nm_lxd}"/etc/apt/apt.conf.d/99boxcache
    rm -f ".99boxcache.$$"

    echo "DOCKER_OPTS='-H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock --storage-driver overlay'" > ".docker.$$"
    lxc file push ".docker.$$" "${nm_lxd}"/etc/default/docker
    rm -f ".docker.$$"
    lxc exec "${nm_lxd}" -- env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y docker.io

    limbo network init
  else
    lxc copy docker/docker0 "$nm_lxd"
    lxc start "$nm_lxd"
    sleep 10
  fi

	lxc exec "${nm_lxd}" -- touch /root/.cloud-init.hostname
	lxc exec "${nm_lxd}" -- rm -rf /var/lib/cloud/instance
	lxc exec "${nm_lxd}" -- cloud-init init
	lxc exec "${nm_lxd}" -- rm -rf /var/lib/cloud/instance
	lxc exec "${nm_lxd}" -- cloud-init init

	lxc restart "${nm_lxd}"
  sleep 10

  local ip_docker="$("$BASEBOX_INSTANCE" lxc info "${nm_lxd}" | egrep 'eth0:\tinet\t' | awk '{print $3}')"
  ssh-keygen -R "$ip_docker"

  limbo vagrant ssh -- sudo route add -net "${net_docker}.0" netmask 255.255.255.0 gw $(lxc info "${nm_lxd}" | egrep 'eth0:\tinet\t' | awk '{print $3}')

  docker machine rm -f "$nm_docker" 2>/dev/null || true
  docker machine create --driver generic --generic-ip-address "$ip_docker" --generic-ssh-user ubuntu \
    --engine-install-url="" \
    --engine-storage-driver="overlay" \
    --engine-opt="bip=${net_docker}.1/24" \
    --engine-opt="insecure-registry=172.28.130.2:5000" \
    "$nm_docker"

  lxc list "${nm_lxd}"
}

source sub "$BASH_SOURCE" "$@"
