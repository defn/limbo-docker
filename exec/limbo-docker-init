#!/usr/bin/env bash

function lxc {
  limbo lxc "$@"
}

function main {
  local shome="${_limbo_home:-"$(cd -P -- "$(dirname -- "$BASH_SOURCE")/.." && pwd -P)"}"
  source "$shome/script/profile"

  local nm_lxd='docker'
  local net_docker="$BASEBOX_DOCKER_NETWORK_PREFIX"
  local nm_docker="$BASEBOX_INSTANCE"

  if [[ "$#" != 0 ]]; then
    nm_lxd="$1"; shift
    nm_docker="$nm_lxd"
    net_docker="$1"; shift
  fi

  set -x

  lxc profile create limbo 2>/dev/null || true
  lxc profile set limbo user.user-data - < "$BLOCK_PATH/limbo/cidata/user-data"
  lxc profile device add docker vagrant disk source=/vagrant path=/vagrant 2>/dev/null || true
  lxc profile device add docker packer disk source=/vagrant/tmp/packer path=/vagrant/tmp/packer 2>/dev/null || true

  lxc config set storage.lvm_volume_size 20GiB

  if [[ "$nm_lxd" == "docker" ]]; then
    lxc launch ubuntu:16.04 "$nm_lxd" -p default -p docker -p limbo -c boot.autostart=true -c security.nesting=false -c security.privileged=false 2>/dev/null || true
    while [[ "$(echo | lxc exec "$nm_lxd" -- systemctl is-active network-online.target)" != "active" ]]; do sleep 1; done

    echo "Acquire::http::Proxy \"http://$CACHE_VIP:3128\";" > ".99boxcache.$$" 
    lxc file push ".99boxcache.$$" "${nm_lxd}"/etc/apt/apt.conf.d/99boxcache
    rm -f ".99boxcache.$$"

    echo "DOCKER_OPTS='-H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock --storage-driver overlay'" > ".docker.$$"
    lxc file push ".docker.$$" "${nm_lxd}"/etc/default/docker
    rm -f ".docker.$$"
    lxc exec "${nm_lxd}" -- env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y docker.io

    limbo network init
  else
    lxc copy docker/docker0 "$nm_lxd"
    lxc start "$nm_lxd"
    while [[ "$(echo | lxc exec "$nm_lxd" -- systemctl is-active network-online.target)" != "active" ]]; do sleep 1; done
  fi

  while ! lxc exec "$nm_lxd" -- ls -ld /var/lib/cloud/instance/boot-finished; do
    sleep 1
  done

	lxc exec "${nm_lxd}" -- touch /root/.cloud-init.hostname

	lxc exec "${nm_lxd}" -- rm -f /var/lib/cloud/instance
	lxc exec "${nm_lxd}" -- cloud-init init

	lxc exec "${nm_lxd}" -- rm -f /var/lib/cloud/instance
	lxc exec "${nm_lxd}" -- cloud-init init

	lxc restart "${nm_lxd}"
  while [[ "$(echo | lxc exec "$nm_lxd" -- systemctl is-active network-online.target)" != "active" ]]; do sleep 1; done
  local ip_docker="$(lxc list "${nm_lxd}" --format json | jq -r '.[].state.network.eth0.addresses[] | select(.family == "inet").address')"
  ssh-keygen -R "$ip_docker"

  if [[ "$nm_lxd" == "docker" ]]; then
    lxc exec "$nm_lxd" -- apt-get install -y aptitude ntp curl unzip git perl ruby language-pack-en nfs-common build-essential dkms lvm2 xfsprogs xfsdump bridge-utils thin-provisioning-tools software-properties-common
    ssh -A "ubuntu@${ip_docker}" ssh -o StrictHostKeyChecking=no git@github.com:defn/home true
    ssh -A "ubuntu@${ip_docker}" git clone git@github.com:defn/home
    ssh "ubuntu@${ip_docker}" mv home/.git .
    ssh "ubuntu@${ip_docker}" git reset --hard
    ssh "ubuntu@${ip_docker}" rm -rf home .profile
    ssh -A "ubuntu@${ip_docker}" make
  fi

  limbo vagrant ssh -- sudo route add -net "${net_docker}.0" netmask 255.255.255.0 gw "$ip_docker"

  docker machine rm -f "$nm_docker" 2>/dev/null || true
  docker machine create --driver generic --generic-ip-address "$ip_docker" --generic-ssh-user ubuntu \
    --engine-install-url="" \
    --engine-storage-driver="overlay" \
    --engine-opt="bip=${net_docker}.1/24" \
    --engine-opt="insecure-registry=172.28.130.2:5000" \
    "$nm_docker"

  lxc list "${nm_lxd}"
}

source sub "$BASH_SOURCE" "$@"
